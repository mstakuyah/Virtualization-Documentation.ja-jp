# <a name="protecting-guest-virtual-machines-from-cve-2017-5715-branch-target-injection"></a>CVE-2017-5715 (分岐先インジェクション) からのゲスト仮想マシンの保護

このページでは、CVE-2017-5715 (分岐先インジェクション) から Hyper-V ホスト上の仮想マシンを保護する際の詳細について説明します。  Windows Server の一般的なガイダンスについては、[このページ](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)を参照してください。

仮想マシンが保護されていることを確認するには、次の手順を実行する必要があります。

1. ホスト オペレーティング システムを更新します。
2. 仮想化ホストが CVE-2017-5715 に対応した更新プログラムを含むファームウェアに更新されていることを確認します。
3. ゲスト仮想マシンに新しいプロセッサの機能を公開するように Hyper-V が構成されていることを確認します。
4. 必要に応じて、ゲスト オペレーティング システムを更新します。 
5. ゲスト仮想マシンのコールド ブートを実行します。

## <a name="update-the-host-operating-system"></a>ホスト オペレーティング システムを更新する

仮想化ホストに Windows オペレーティング システムの更新プログラムを適用します。 この更新プログラムを有効にする方法については、[マイクロソフト サポート技術情報 4072699](https://support.microsoft.com/help/4072699) を参照してください。

## <a name="ensure-the-virtualization-host-has-been-updated-to-firmware-which-contains-updates-for-cve-2017-5715"></a>仮想化ホストが CVE-2017-5715 に対応した更新プログラムを含むファームウェアに更新されていることを確認する

OEM から提供されるファームウェアの更新プログラムに、CVE-2017-5715 ([IBRS、STIBP、IBPB](https://newsroom.intel.com/wp-content/uploads/sites/11/2018/01/Intel-Analysis-of-Speculative-Execution-Side-Channels.pdf)) からの保護に使用できる新しいプロセッサの機能が含まれている可能性があります。  仮想化ホストのファームウェアを更新した後、ハイパーバイザーで次の手順を実行すると、これらの追加機能をゲスト仮想マシンで利用できるようになります。

## <a name="ensure-hyper-v-is-configured-to-expose-new-processor-capabilities-to-guest-virtual-machines"></a>ゲスト仮想マシンに新しいプロセッサの機能を公開するように Hyper-V が構成されていることを確認する

新しいプロセッサ機能をゲスト仮想マシンに公開するように Hyper-v が構成されていることを確認します。  この構成は、ゲスト仮想マシンの [VM バージョン](https://docs.microsoft.com/windows-server/virtualization/hyper-v/deploy/upgrade-virtual-machine-version-in-hyper-v-on-windows-or-windows-server)に基づいています。 

ホスト上のすべての仮想マシンが VM バージョン 8.0 以降である場合、構成は必要ありません。  これらの仮想マシンでは、コールド ブート後に、プロセッサの新機能が認識されます。

VM バージョン 8.0 未満の仮想マシンがある場合は、ホスト オペレーティング システムで特定のレジストリ値を設定する必要があります。  これによって、以前の VM バージョンのゲスト仮想マシンに新しいプロセッサの機能を公開するように Hyper-V が構成されます。

このレジストリ値は、`MinVmVersionForCpuBasedMitigations` の下にある `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization` です。  値は、最新のファームウェア機能にアクセスする必要がある最低限の VM バージョン (メジャー.マイナー形式) に設定する必要があります。  ホスト上のすべての仮想マシンにファームウェア (つまりバージョン 1.0 以上) を公開するには、ホストで次のコマンドを実行します。 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v MinVmVersionForCpuBasedMitigations /t REG_SZ /d "1.0" /f
```
*注: VM バージョン8.0 は、Windows Server 2016 と Windows 10 記念日更新プログラムで導入されました。 Windows Server 2012 R2 以降を実行しているホストでは、レジストリ値を設定する必要があります*

*警告: 更新されたファームウェアとホストの間でライブマイグレーションが更新され、ファームウェアが更新されることはありません。 詳細については、このドキュメントの下部にある FAQ を参照してください。*

## <a name="optional-configure-_pre-skylake_-intel-systems-to-use-retpoline"></a>*省略可能*: _Skylake_ Intel Systems が retpoline を使用するように構成する

*警告: Retpoline の Skylake Intel ホストで Vm を構成すると、新しいホストへのライブマイグレーション (つまり Skylake 以降) がブロックされます。*

既定では、Skylake システム上で実行されている仮想マシンは、retpoline を使用できません。  これらのシステムが retpoline ベースの軽減策を利用できるようにするには、`HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization` の下に `RetsPredictedFromRsbOnly` を `1`に設定します。 

```
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization" /v RetsPredictedFromRsbOnly /t REG_DWORD /d 1 /f
```

この構成を逆にする (つまり、仮想マシンが retpoline を利用できないようにする) には、`RetsPredictedFromRsbOnly` を `0`に設定します。

## <a name="update-the-guest-operating-system"></a>ゲスト オペレーティング システムを更新する

これらの仮想マシン内で CVE-2017-5715 に対する保護を完了するには、ゲスト オペレーティング システムを更新してこれらの新機能を利用するように構成する必要があります。  Microsoft のオペレーティング システムの場合は、更新時に[この記事](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)のガイダンスに従ってください。

*注: ゲストオペレーティングシステムの更新は、このプロセスでいつでも実行できます。 ホストのファームウェアを更新する前、またはゲストバーチャルマシンをコールドブートした後に発生する可能性があります。*

## <a name="perform-a-cold-boot-of-the-guest"></a>ゲストのコールド ブートを実行する

最初の 3 つの手順を完了した後、新しいプロセッサ機能を参照するには仮想マシンのコールド ブートを実行する必要があります。  つまり、実行中の VM を完全に電源オフの状態にしてから、もう一度開始する必要があります。  ゲスト オペレーティング システム内から再起動するだけでは不十分です。

## <a name="frequently-asked-questions"></a>よく寄せられる質問

### <a name="how-does-this-impact-live-migration"></a>これはライブ マイグレーションにどのように影響しますか。

新しいプロセッサ機能を備えた仮想マシンのライブ マイグレーションは、ファームウェアが更新されていない Hyper-V ホストに移行するときに失敗します。  ファームウェアが更新されていないホストへのライブ マイグレーションを有効にするには、ゲスト仮想マシン内で更新されたプロセッサ機能を公開することを停止します。  これを行う最も簡単な方法は、`MinVmVersionForCpuBasedMitigations` を、移行する必要がある仮想マシンの VM バージョンよりも大きい値に変更し、その仮想マシンのコールド ブートを実行することです。

新しいプロセッサ機能を備えていない仮想マシンの移行は、ファームウェアが更新されている Hyper-V ホストに移行する場合は成功します。  ただし、これらのゲストで更新されたファームウェア機能を確認するには、コールド ブートを実行する必要があります。

Skylake の Intel システムで Retpoline を使用するように構成された仮想マシンは、新しいプロセッサファミリ (つまり、Skylake 以降) に移行できません。

### <a name="what-about-live-migration-of-version-50-virtual-machines-between-windows-server-2012r2-and-windows-server-2016"></a>Windows Server 2012R2 と Windows Server 2016 の間で、バージョン 5.0 の仮想マシンのライブ マイグレーションを実行するとどうなりますか。
このシナリオを成功させるには、Windows Server 2012R2 システムと Windows Server 2016 システムの両方でレジストリ値を設定する必要があります。  Windows Server 2016 に移行した後も、VM バージョンは 5.0 のままであるため、仮想マシンに新しいプロセッサ機能を公開するにはレジストリ キーが必要です。  

### <a name="does-this-guidance-apply-to-virtual-machines-running-on-vmware"></a>このガイダンスは、VMware で実行される仮想マシンに適用されますか。
いいえ。このガイダンスは、Hyper-V ホストで実行されている仮想マシンに固有です。

### <a name="does-this-guidance-apply-to-hyper-v-on-windows-10"></a>このガイダンスは、Windows 10 の Hyper-V に適用されますか。
はい。Windows Sever とクライアントの両方で実行される仮想マシンに同じ手順が適用されます。

### <a name="do-i-need-to-install-the-firmware-updates-before-performing-a-cold-boot-of-the-virtual-machines"></a>仮想マシンのコールド ブートを実行する前に、ファームウェア更新プログラムをインストールする必要がありますか。
はい。仮想マシンのコールド ブートを実行する前に、ホスト オペレーティング システムとファームウェアを更新する必要があります。

### <a name="what-can-i-do-if-my-oem-does-not-yet-provide-an-updated-firmware"></a>まだ OEM が更新されたファームウェアを提供していない場合は、どうすればよいですか。
「[投機的実行のサイドチャネルの脆弱性から Windows Server 2016 Hyper-V ホストを保護するための代替手段](https://docs.microsoft.com/virtualization/hyper-v-on-windows/CVE-2017-5715-and-hyper-v-hosts)」を参照してください。

### <a name="how-do-i-check-the-vm-version-for-my-virtual-machines"></a>仮想マシンの VM バージョンを確認する方法を教えてください。
Hyper-V ホスト上で次の PowerShell コマンドを実行します。
``` PowerShell
Get-VM * | Format-Table Name, Version  
```

### <a name="do-i-need-to-do-something-different-to-protect-virtual-machines-running-under-processor-compatibility-mode"></a>"プロセッサ互換性モード" で実行されている仮想マシンを保護するために、何か異なる処理を行う必要がありますか。
No:  このページで説明した手順に従うと、プロセッサ互換性モードで起動された仮想マシンにも新しいプロセッサ機能が公開されます。

### <a name="what-if-only-half-of-the-machines-in-my-cluster-have-received-a-firmware-update"></a>クラスター内の半分のコンピューターにのみファームウェアの更新プログラムが適用されている場合はどうなりますか。
これは、クラスター内のライブ マイグレーションに影響します。  新しいプロセッサ機能を備えている仮想マシンは、ファームウェアが更新されていないホストへのライブ マイグレーションを実行できません。  

### <a name="how-can-i-validate-that-the-guest-virtual-machine-has-access-to-the-new-processor-features"></a>ゲスト仮想マシンが新しいプロセッサ機能にアクセスできることを検証する方法を教えてください。
"投機実行の制御" に関連する PowerShell モジュール/スクリプトを使用します。  詳細な手順については、[このページ](https://support.microsoft.com/help/4072698/windows-server-guidance-to-protect-against-the-speculative-execution)を参照してください。

